<!DOCTYPE html>
<html lang="en">
<head>
    <title>Kwizzz</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap Styles and Scripts -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Socket.io scripts (from node module)-->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Custom Styles and Scripts -->
    <link rel="stylesheet" href="stylesheets/style.css">
    <script src="scripts/kwiz.js"></script>

</head>
<body>

<div class="container">
    <div class="jumbotron">
        <h1>Kwizzz</h1>
        <p>Interactive and Multi-User Quizz.</p>
    </div>
    <div class="row">
        <p class="col-md-6" id="player_name"></p>
        <p class="col-md-6 text-right" id="nb_of_players"></p>
    </div>
    <!-- Main content. WARNING, DO NOT ADD ELEMENT IN THERE IT WILL BE DELETED -->
    <div class="row" id="alert_container"></div>
    <div id="content" class="row">
        <form class="form-horizontal col-md-12 row">
            <div class="form-group">
                <label class="control-label col-sm-2" for="nickname">Pseudo:</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="nickname">
                </div>
            </div>
            <div class="col-sm-offset-2 col-sm-10">
                <a href="#" type="submit" class="btn btn-default" onclick="login()">Jouer !</a>
            </div>
        </form>
    </div>

    <div class="row" id="clients">
        <p class="col-xs-12" id="clientCount">Aucun joueur en ligne.</p>
        <table class="table col-xs-12" id="playersTable">
            <thead>
                <tr>
                    <!-- <th>ID</th> -->
                    <th>Pseudo</th>
                    <th>Score</th>
                </tr>
            </thead>
        </table>
    </div>

</div>


<footer id="site-footer" class="contain well">
    <span class="col-xs-6 pull-right text-right">Copyright &copy;KWIZZZ 2017</span>
</footer>

<script language="javascript">

    let socket = io(); //'http://localhost:8080'

    socket.on(EVENT_CLIENT_COUNT,(data)=>{
        var text;
        if(data["count"]>1){
            text = " clients en ligne."
        }else{
            text = " client en ligne."
        }
        document.getElementById("clientCount").innerText = data["count"]+text;

        var waitCounter = document.getElementById("wait_counter");
        if(typeof waitCounter !== 'undefined' && waitCounter!== null){
            waitCounter.innerHTML= document.getElementById("playersTable").rows.length-1+"/"+data.count;
        }
    });

    socket.on(EVENT_PLAYERS,(data)=>{
        var players = data['players'];
        var playersTable = document.getElementById("playersTable");

        while (playersTable.children[1]) {
            playersTable.removeChild(playersTable.children[1]);
        }

        for(let playerID in players){
            if(players.hasOwnProperty(playerID)){
                line = document.createElement('tr');

                /*id = document.createElement('td');
                id.innerHTML = players[playerID].id;
                line.appendChild(id);*/

                nickname = document.createElement('td');
                nickname.innerHTML = players[playerID].nickname;
                line.appendChild(nickname);

                score = document.createElement('td');
                score.innerHTML = players[playerID].score;
                line.appendChild(score);

                playersTable.appendChild(line);
            }
        }

        let nbPlayers = playersTable.rows.length-1;
        if(nbPlayers > 0){
            document.getElementById('nb_of_players').innerHTML = "Nombre de joueurs : "+nbPlayers;
        }

        var waitCounter = document.getElementById("wait_counter");
        if(typeof waitCounter !== 'undefined' && waitCounter!== null){
            var clientsCount = document.getElementById("clientCount").innerHTML.substr(0,1);
            waitCounter.innerHTML=nbPlayers+"/"+clientsCount;
        }
    });


    function login(){
        var nickname = document.getElementById("nickname").value;

        if(nickname === ""){
            document.getElementById("alert_container").innerHTML = "<div class='alert alert-warning alert-dismissable'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a><strong>Attention !</strong> Vous n'avez pas entré de pseudo.</div>";
        }else{
            socket.on(EVENT_NICKNAME_TEST_RESPONSE,nicknameTestResponse)
            socket.emit(EVENT_TEST_NICKNAME,{id:socket["id"],nickname:nickname});
        }
    }


    function nicknameTestResponse(data) {
        if(data.nicknameTaken == 0){
            document.getElementById('player_name').innerHTML = "Pseudo : "+data.nickname;
            socket.emit(EVENT_LOGGED_IN,{id:socket["id"],nickname:data.nickname});
            kwiz.start(socket);
        }else{
            document.getElementById("alert_container").innerHTML = "<div class='alert alert-danger alert-dismissable'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a><strong>Attention !</strong> Ce pseudo est déjà pris.</div>";
        }
    }
</script>

</body>
</html>
